-module(api_versions_response_tests).
-include_lib("eunit/include/eunit.hrl").

v2_test() ->
    Capture =
        <<0, 0, 0, 1, 0, 0, 0, 0, 0, 54, 0, 0, 0, 0, 0, 8, 0, 1, 0, 0, 0, 12, 0, 2, 0, 0, 0, 5, 0,
            3, 0, 0, 0, 9, 0, 4, 0, 0, 0, 4, 0, 5, 0, 0, 0, 3, 0, 6, 0, 0, 0, 6, 0, 7, 0, 0, 0, 3,
            0, 8, 0, 0, 0, 8, 0, 9, 0, 0, 0, 7, 0, 10, 0, 0, 0, 3, 0, 11, 0, 0, 0, 7, 0, 12, 0, 0,
            0, 4, 0, 13, 0, 0, 0, 4, 0, 14, 0, 0, 0, 5, 0, 15, 0, 0, 0, 5, 0, 16, 0, 0, 0, 4, 0, 17,
            0, 0, 0, 1, 0, 18, 0, 0, 0, 3, 0, 19, 0, 0, 0, 6, 0, 20, 0, 0, 0, 5, 0, 21, 0, 0, 0, 2,
            0, 22, 0, 0, 0, 4, 0, 23, 0, 0, 0, 3, 0, 24, 0, 0, 0, 2, 0, 25, 0, 0, 0, 2, 0, 26, 0, 0,
            0, 2, 0, 27, 0, 0, 0, 0, 0, 28, 0, 0, 0, 3, 0, 29, 0, 0, 0, 2, 0, 30, 0, 0, 0, 2, 0, 31,
            0, 0, 0, 2, 0, 32, 0, 0, 0, 3, 0, 33, 0, 0, 0, 1, 0, 34, 0, 0, 0, 1, 0, 35, 0, 0, 0, 2,
            0, 36, 0, 0, 0, 2, 0, 37, 0, 0, 0, 3, 0, 38, 0, 0, 0, 2, 0, 39, 0, 0, 0, 2, 0, 40, 0, 0,
            0, 2, 0, 41, 0, 0, 0, 2, 0, 42, 0, 0, 0, 2, 0, 43, 0, 0, 0, 2, 0, 44, 0, 0, 0, 1, 0, 45,
            0, 0, 0, 0, 0, 46, 0, 0, 0, 0, 0, 47, 0, 0, 0, 0, 0, 48, 0, 0, 0, 0, 0, 49, 0, 0, 0, 0,
            0, 50, 0, 0, 0, 0, 0, 51, 0, 0, 0, 0, 0, 56, 0, 0, 0, 0, 0, 57, 0, 0, 0, 0, 0, 0, 0,
            0>>,
    Expected = canned_v2_response(),
    ?assertEqual({Expected, <<>>}, api_versions_response:decode_api_versions_response_2(Capture)).

canned_v2_response() ->
    #{
        correlation_id => 1,
        error_code => 0,
        throttle_time_ms => 0,
        api_keys =>
            [
                #{api_key => 0, max_version => 8, min_version => 0},
                #{api_key => 1, max_version => 12, min_version => 0},
                #{api_key => 2, max_version => 5, min_version => 0},
                #{api_key => 3, max_version => 9, min_version => 0},
                #{api_key => 4, max_version => 4, min_version => 0},
                #{api_key => 5, max_version => 3, min_version => 0},
                #{api_key => 6, max_version => 6, min_version => 0},
                #{api_key => 7, max_version => 3, min_version => 0},
                #{api_key => 8, max_version => 8, min_version => 0},
                #{api_key => 9, max_version => 7, min_version => 0},
                #{api_key => 10, max_version => 3, min_version => 0},
                #{api_key => 11, max_version => 7, min_version => 0},
                #{api_key => 12, max_version => 4, min_version => 0},
                #{api_key => 13, max_version => 4, min_version => 0},
                #{api_key => 14, max_version => 5, min_version => 0},
                #{api_key => 15, max_version => 5, min_version => 0},
                #{api_key => 16, max_version => 4, min_version => 0},
                #{api_key => 17, max_version => 1, min_version => 0},
                #{api_key => 18, max_version => 3, min_version => 0},
                #{api_key => 19, max_version => 6, min_version => 0},
                #{api_key => 20, max_version => 5, min_version => 0},
                #{api_key => 21, max_version => 2, min_version => 0},
                #{api_key => 22, max_version => 4, min_version => 0},
                #{api_key => 23, max_version => 3, min_version => 0},
                #{api_key => 24, max_version => 2, min_version => 0},
                #{api_key => 25, max_version => 2, min_version => 0},
                #{api_key => 26, max_version => 2, min_version => 0},
                #{api_key => 27, max_version => 0, min_version => 0},
                #{api_key => 28, max_version => 3, min_version => 0},
                #{api_key => 29, max_version => 2, min_version => 0},
                #{api_key => 30, max_version => 2, min_version => 0},
                #{api_key => 31, max_version => 2, min_version => 0},
                #{api_key => 32, max_version => 3, min_version => 0},
                #{api_key => 33, max_version => 1, min_version => 0},
                #{api_key => 34, max_version => 1, min_version => 0},
                #{api_key => 35, max_version => 2, min_version => 0},
                #{api_key => 36, max_version => 2, min_version => 0},
                #{api_key => 37, max_version => 3, min_version => 0},
                #{api_key => 38, max_version => 2, min_version => 0},
                #{api_key => 39, max_version => 2, min_version => 0},
                #{api_key => 40, max_version => 2, min_version => 0},
                #{api_key => 41, max_version => 2, min_version => 0},
                #{api_key => 42, max_version => 2, min_version => 0},
                #{api_key => 43, max_version => 2, min_version => 0},
                #{api_key => 44, max_version => 1, min_version => 0},
                #{api_key => 45, max_version => 0, min_version => 0},
                #{api_key => 46, max_version => 0, min_version => 0},
                #{api_key => 47, max_version => 0, min_version => 0},
                #{api_key => 48, max_version => 0, min_version => 0},
                #{api_key => 49, max_version => 0, min_version => 0},
                #{api_key => 50, max_version => 0, min_version => 0},
                #{api_key => 51, max_version => 0, min_version => 0},
                #{api_key => 56, max_version => 0, min_version => 0},
                #{api_key => 57, max_version => 0, min_version => 0}
            ]
    }.

captured_v3_response() ->
    <<0, 0, 0, 0, 0, 0, 61, 0, 0, 0, 0, 0, 9, 0, 0, 1, 0, 0, 0, 13, 0, 0, 2, 0, 0, 0, 7, 0, 0, 3, 0,
        0, 0, 12, 0, 0, 4, 0, 0, 0, 7, 0, 0, 5, 0, 0, 0, 4, 0, 0, 6, 0, 0, 0, 8, 0, 0, 7, 0, 0, 0,
        3, 0, 0, 8, 0, 0, 0, 8, 0, 0, 9, 0, 0, 0, 8, 0, 0, 10, 0, 0, 0, 4, 0, 0, 11, 0, 0, 0, 9, 0,
        0, 12, 0, 0, 0, 4, 0, 0, 13, 0, 0, 0, 5, 0, 0, 14, 0, 0, 0, 5, 0, 0, 15, 0, 0, 0, 5, 0, 0,
        16, 0, 0, 0, 4, 0, 0, 17, 0, 0, 0, 1, 0, 0, 18, 0, 0, 0, 3, 0, 0, 19, 0, 0, 0, 7, 0, 0, 20,
        0, 0, 0, 6, 0, 0, 21, 0, 0, 0, 2, 0, 0, 22, 0, 0, 0, 4, 0, 0, 23, 0, 0, 0, 4, 0, 0, 24, 0,
        0, 0, 3, 0, 0, 25, 0, 0, 0, 3, 0, 0, 26, 0, 0, 0, 3, 0, 0, 27, 0, 0, 0, 1, 0, 0, 28, 0, 0,
        0, 3, 0, 0, 29, 0, 0, 0, 3, 0, 0, 30, 0, 0, 0, 3, 0, 0, 31, 0, 0, 0, 3, 0, 0, 32, 0, 0, 0,
        4, 0, 0, 33, 0, 0, 0, 2, 0, 0, 34, 0, 0, 0, 2, 0, 0, 35, 0, 0, 0, 4, 0, 0, 36, 0, 0, 0, 2,
        0, 0, 37, 0, 0, 0, 3, 0, 0, 38, 0, 0, 0, 3, 0, 0, 39, 0, 0, 0, 2, 0, 0, 40, 0, 0, 0, 2, 0,
        0, 41, 0, 0, 0, 3, 0, 0, 42, 0, 0, 0, 2, 0, 0, 43, 0, 0, 0, 2, 0, 0, 44, 0, 0, 0, 1, 0, 0,
        45, 0, 0, 0, 0, 0, 0, 46, 0, 0, 0, 0, 0, 0, 47, 0, 0, 0, 0, 0, 0, 48, 0, 0, 0, 1, 0, 0, 49,
        0, 0, 0, 1, 0, 0, 50, 0, 0, 0, 0, 0, 0, 51, 0, 0, 0, 0, 0, 0, 56, 0, 0, 0, 2, 0, 0, 57, 0,
        0, 0, 1, 0, 0, 58, 0, 0, 0, 0, 0, 0, 60, 0, 0, 0, 0, 0, 0, 61, 0, 0, 0, 0, 0, 0, 65, 0, 0,
        0, 0, 0, 0, 66, 0, 0, 0, 0, 0, 0, 67, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 8, 0, 0, 0, 0, 0, 0,
        0, 0>>.

encode_v3_response_with_tagged_fields_test() ->
    Response = canned_v3_response(),
    Capture = captured_v3_response(),
    ?assertEqual(
        Capture, iolist_to_binary(api_versions_response:encode_api_versions_response_3(Response))
    ),
    ok.

decode_v3_response_with_tagged_fields_test() ->
    Capture = captured_v3_response(),
    ?assertEqual(
        {canned_v3_response(), <<>>}, api_versions_response:decode_api_versions_response_3(Capture)
    ),
    ok.

canned_v3_response() ->
    #{
        correlation_id => 0,
        api_keys =>
            [
                #{api_key => 0, max_version => 9, min_version => 0},
                #{api_key => 1, max_version => 13, min_version => 0},
                #{api_key => 2, max_version => 7, min_version => 0},
                #{api_key => 3, max_version => 12, min_version => 0},
                #{api_key => 4, max_version => 7, min_version => 0},
                #{api_key => 5, max_version => 4, min_version => 0},
                #{api_key => 6, max_version => 8, min_version => 0},
                #{api_key => 7, max_version => 3, min_version => 0},
                #{api_key => 8, max_version => 8, min_version => 0},
                #{api_key => 9, max_version => 8, min_version => 0},
                #{api_key => 10, max_version => 4, min_version => 0},
                #{api_key => 11, max_version => 9, min_version => 0},
                #{api_key => 12, max_version => 4, min_version => 0},
                #{api_key => 13, max_version => 5, min_version => 0},
                #{api_key => 14, max_version => 5, min_version => 0},
                #{api_key => 15, max_version => 5, min_version => 0},
                #{api_key => 16, max_version => 4, min_version => 0},
                #{api_key => 17, max_version => 1, min_version => 0},
                #{api_key => 18, max_version => 3, min_version => 0},
                #{api_key => 19, max_version => 7, min_version => 0},
                #{api_key => 20, max_version => 6, min_version => 0},
                #{api_key => 21, max_version => 2, min_version => 0},
                #{api_key => 22, max_version => 4, min_version => 0},
                #{api_key => 23, max_version => 4, min_version => 0},
                #{api_key => 24, max_version => 3, min_version => 0},
                #{api_key => 25, max_version => 3, min_version => 0},
                #{api_key => 26, max_version => 3, min_version => 0},
                #{api_key => 27, max_version => 1, min_version => 0},
                #{api_key => 28, max_version => 3, min_version => 0},
                #{api_key => 29, max_version => 3, min_version => 0},
                #{api_key => 30, max_version => 3, min_version => 0},
                #{api_key => 31, max_version => 3, min_version => 0},
                #{api_key => 32, max_version => 4, min_version => 0},
                #{api_key => 33, max_version => 2, min_version => 0},
                #{api_key => 34, max_version => 2, min_version => 0},
                #{api_key => 35, max_version => 4, min_version => 0},
                #{api_key => 36, max_version => 2, min_version => 0},
                #{api_key => 37, max_version => 3, min_version => 0},
                #{api_key => 38, max_version => 3, min_version => 0},
                #{api_key => 39, max_version => 2, min_version => 0},
                #{api_key => 40, max_version => 2, min_version => 0},
                #{api_key => 41, max_version => 3, min_version => 0},
                #{api_key => 42, max_version => 2, min_version => 0},
                #{api_key => 43, max_version => 2, min_version => 0},
                #{api_key => 44, max_version => 1, min_version => 0},
                #{api_key => 45, max_version => 0, min_version => 0},
                #{api_key => 46, max_version => 0, min_version => 0},
                #{api_key => 47, max_version => 0, min_version => 0},
                #{api_key => 48, max_version => 1, min_version => 0},
                #{api_key => 49, max_version => 1, min_version => 0},
                #{api_key => 50, max_version => 0, min_version => 0},
                #{api_key => 51, max_version => 0, min_version => 0},
                #{api_key => 56, max_version => 2, min_version => 0},
                #{api_key => 57, max_version => 1, min_version => 0},
                #{api_key => 58, max_version => 0, min_version => 0},
                #{api_key => 60, max_version => 0, min_version => 0},
                #{api_key => 61, max_version => 0, min_version => 0},
                #{api_key => 65, max_version => 0, min_version => 0},
                #{api_key => 66, max_version => 0, min_version => 0},
                #{api_key => 67, max_version => 0, min_version => 0}
            ],
        error_code => 0,
        finalized_features_epoch => 0,
        throttle_time_ms => 0
    }.
